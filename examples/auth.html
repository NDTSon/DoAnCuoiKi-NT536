<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÄÄƒng nháº­p / ÄÄƒng kÃ½ - LiveKit</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .auth-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      max-width: 450px;
      width: 100%;
      animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .auth-header {
      background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
      padding: 40px 30px;
      text-align: center;
      color: white;
    }

    .auth-header h1 {
      font-size: 2em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .auth-header p {
      opacity: 0.9;
      font-size: 0.95em;
    }

    .auth-body {
      padding: 40px 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #374151;
      font-weight: 600;
      font-size: 0.9em;
    }

    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 1em;
      transition: all 0.3s;
      background: #f9fafb;
    }

    .form-group input:focus {
      outline: none;
      border-color: #ec4899;
      background: white;
      box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 30px;
    }

    .btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(236, 72, 153, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .message {
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 0.9em;
      display: none;
    }

    .message.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
      display: block;
    }

    .message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
      display: block;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .divider {
      text-align: center;
      margin: 30px 0;
      color: #9ca3af;
      font-size: 0.9em;
      position: relative;
    }

    .divider::before,
    .divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: #e5e7eb;
    }

    .divider::before {
      left: 0;
    }

    .divider::after {
      right: 0;
    }
  </style>
  <script>
    let isLoading = false;

    // Get return URL from query params
    const urlParams = new URLSearchParams(window.location.search);
    let returnUrl = urlParams.get('return') || '/examples/watch-stream.html';
    
    // Normalize return URL - convert file:// to HTTP if needed
    function normalizeReturnUrl(url) {
      if (!url) return '/examples/watch-stream.html';
      
      // If it's a file:// URL, extract the path and convert to HTTP
      if (url.startsWith('file://')) {
        // Extract path from file:// URL
        try {
          const fileUrl = new URL(url);
          const path = fileUrl.pathname;
          // Convert Windows path (C:/...) to HTTP path
          // Remove drive letter and convert to HTTP path
          const httpPath = path.replace(/^\/[A-Z]:/, '').replace(/\\/g, '/');
          // If path contains 'examples', use it, otherwise default
          if (httpPath.includes('examples')) {
            return httpPath;
          }
          return '/examples/watch-stream.html';
        } catch (e) {
          console.warn('Error parsing file:// URL:', e);
          return '/examples/watch-stream.html';
        }
      }
      
      // If it's already HTTP, return as is
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return url;
      }
      
      // Relative path
      return url;
    }
    
    returnUrl = normalizeReturnUrl(returnUrl);

    function showMessage(text, isError = false) {
      const msgEl = document.getElementById('message');
      msgEl.textContent = text;
      msgEl.className = 'message ' + (isError ? 'error' : 'success');
      setTimeout(() => {
        msgEl.className = 'message';
      }, 5000);
    }

    function setLoading(loading) {
      isLoading = loading;
      const registerBtn = document.getElementById('btn-register');
      const loginBtn = document.getElementById('btn-login');
      
      if (loading) {
        registerBtn.disabled = true;
        loginBtn.disabled = true;
        registerBtn.innerHTML = '<span class="loading"></span> Äang xá»­ lÃ½...';
        loginBtn.innerHTML = '<span class="loading"></span> Äang xá»­ lÃ½...';
      } else {
        registerBtn.disabled = false;
        loginBtn.disabled = false;
        registerBtn.innerHTML = 'ğŸ“ ÄÄƒng kÃ½';
        loginBtn.innerHTML = 'ğŸ” ÄÄƒng nháº­p';
      }
    }

    async function registerUser() {
      if (isLoading) return;
      
      // Check if running from file://
      if (window.location.protocol === 'file:') {
        showMessage('âŒ Vui lÃ²ng má»Ÿ trang qua HTTP server (http://localhost:7880/examples/auth.html) Ä‘á»ƒ sá»­ dá»¥ng tÃ­nh nÄƒng Ä‘Äƒng kÃ½!', true);
        return;
      }
      
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const displayName = document.getElementById('displayName').value.trim();

      if (!email || !password) {
        showMessage('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ email vÃ  máº­t kháº©u!', true);
        return;
      }

      if (password.length < 6) {
        showMessage('Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±!', true);
        return;
      }

      setLoading(true);
      
      try {
        const res = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, displayName: displayName || email.split('@')[0] })
        });

        // Parse response - handle both JSON and text errors
        let data;
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          try {
            data = await res.json();
          } catch (parseError) {
            throw new Error('Lá»—i khi xá»­ lÃ½ pháº£n há»“i tá»« server');
          }
        } else {
          // Non-JSON response (shouldn't happen with our API, but handle it)
          const text = await res.text();
          throw new Error(text || 'ÄÄƒng kÃ½ tháº¥t báº¡i');
        }
        
        if (!res.ok) {
          throw new Error(data.error || 'ÄÄƒng kÃ½ tháº¥t báº¡i');
        }

        if (data.token && data.user) {
          showMessage('âœ… ÄÄƒng kÃ½ thÃ nh cÃ´ng! Äang chuyá»ƒn hÆ°á»›ng...', false);
          
          // Redirect back to watch-stream with user info
          let redirectUrl;
          if (returnUrl.startsWith('http://') || returnUrl.startsWith('https://')) {
            redirectUrl = new URL(returnUrl);
          } else {
            // Relative path - construct full URL
            redirectUrl = new URL(returnUrl, window.location.origin);
          }
          redirectUrl.searchParams.set('token', data.token);
          redirectUrl.searchParams.set('name', data.user.displayName || data.user.email);
          redirectUrl.searchParams.set('email', data.user.email);
          
          setTimeout(() => {
            window.location.href = redirectUrl.toString();
          }, 1000);
        } else {
          throw new Error('KhÃ´ng nháº­n Ä‘Æ°á»£c token tá»« server');
        }
      } catch (error) {
        console.error('Register error:', error);
        showMessage('âŒ ' + error.message, true);
        setLoading(false);
      }
    }

    async function loginUser() {
      if (isLoading) return;
      
      // Check if running from file://
      if (window.location.protocol === 'file:') {
        showMessage('âŒ Vui lÃ²ng má»Ÿ trang qua HTTP server (http://localhost:7880/examples/auth.html) Ä‘á»ƒ sá»­ dá»¥ng tÃ­nh nÄƒng Ä‘Äƒng nháº­p!', true);
        return;
      }
      
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) {
        showMessage('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ email vÃ  máº­t kháº©u!', true);
        return;
      }

      setLoading(true);
      
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        // Parse response - handle both JSON and text errors
        let data;
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          try {
            data = await res.json();
          } catch (parseError) {
            throw new Error('Lá»—i khi xá»­ lÃ½ pháº£n há»“i tá»« server');
          }
        } else {
          // Non-JSON response (shouldn't happen with our API, but handle it)
          const text = await res.text();
          throw new Error(text || 'ÄÄƒng nháº­p tháº¥t báº¡i');
        }
        
        if (!res.ok) {
          if (res.status === 401) {
            throw new Error('Email hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng!');
          }
          throw new Error(data.error || 'ÄÄƒng nháº­p tháº¥t báº¡i');
        }

        if (data.token && data.user) {
          showMessage('âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng! Äang chuyá»ƒn hÆ°á»›ng...', false);
          
          // Redirect back to watch-stream with user info
          let redirectUrl;
          if (returnUrl.startsWith('http://') || returnUrl.startsWith('https://')) {
            redirectUrl = new URL(returnUrl);
          } else {
            // Relative path - construct full URL
            redirectUrl = new URL(returnUrl, window.location.origin);
          }
          redirectUrl.searchParams.set('token', data.token);
          redirectUrl.searchParams.set('name', data.user.displayName || data.user.email);
          redirectUrl.searchParams.set('email', data.user.email);
          
          setTimeout(() => {
            window.location.href = redirectUrl.toString();
          }, 1000);
        } else {
          throw new Error('KhÃ´ng nháº­n Ä‘Æ°á»£c token tá»« server');
        }
      } catch (error) {
        console.error('Login error:', error);
        showMessage('âŒ ' + error.message, true);
        setLoading(false);
      }
    }

    function goBack() {
      if (returnUrl.startsWith('file://')) {
        // For file://, try to go back or use default
        if (window.history.length > 1) {
          window.history.back();
        } else {
          window.location.href = '/examples/watch-stream.html';
        }
      } else {
        window.location.href = returnUrl;
      }
    }

    // Check if running from file:// and show warning
    document.addEventListener('DOMContentLoaded', () => {
      const isFileProtocol = window.location.protocol === 'file:';
      
      if (isFileProtocol) {
        showMessage('âš ï¸ Báº¡n Ä‘ang má»Ÿ file trá»±c tiáº¿p. Vui lÃ²ng má»Ÿ qua HTTP server: http://localhost:7880/examples/watch-stream.html', true);
      }
      
      document.getElementById('password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !isLoading) {
          loginUser();
        }
      });
    });
  </script>
</head>
<body>
  <div class="auth-container">
    <div class="auth-header">
      <h1>ğŸ” LiveKit</h1>
      <p>ÄÄƒng nháº­p hoáº·c táº¡o tÃ i khoáº£n má»›i</p>
    </div>
    <div class="auth-body">
      <div id="message" class="message"></div>
      
      <div class="form-group">
        <label for="email">ğŸ“§ Email</label>
        <input id="email" type="email" placeholder="your@email.com" required />
      </div>
      
      <div class="form-group">
        <label for="password">ğŸ”’ Máº­t kháº©u</label>
        <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
      </div>
      
      <div class="form-group">
        <label for="displayName">ğŸ‘¤ TÃªn hiá»ƒn thá»‹ (tÃ¹y chá»n)</label>
        <input id="displayName" type="text" placeholder="TÃªn cá»§a báº¡n" />
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" id="btn-register" onclick="registerUser()">
          ğŸ“ ÄÄƒng kÃ½
        </button>
        <button class="btn btn-secondary" id="btn-login" onclick="loginUser()">
          ğŸ” ÄÄƒng nháº­p
        </button>
      </div>

      <div class="divider">hoáº·c</div>
      
      <button class="btn btn-secondary" style="width: 100%;" onclick="goBack()">
        â† Quay láº¡i xem stream
      </button>
    </div>
  </div>
</body>
</html>
