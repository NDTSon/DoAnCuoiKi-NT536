<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Đăng nhập / Đăng ký - StreamG8</title>
  <style>
    :root {
      --twitch-purple: #9147ff;
      --twitch-purple-hover: #772ce8;
      --bg-body: #0e0e10;
      --bg-surface: #18181b;
      --bg-input: #0e0e10;
      --text-base: #efeff1;
      --text-alt: #adadb8;
      --border-color: #303032;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Roobert', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background-color: var(--bg-body);
      color: var(--text-base);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .auth-container {
      background: var(--bg-surface);
      border-radius: 8px;
      /* box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); */
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .auth-header {
      padding: 30px 30px 10px 30px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    /* Logo Styling */
    .logo-icon {
      width: 60px;
      height: 60px;
    }

    .logo-text {
      font-size: 1.8em;
      font-weight: 800;
      color: var(--twitch-purple);
      letter-spacing: -1px;
    }

    .auth-header p {
      color: var(--text-alt);
      font-size: 0.95em;
      margin-top: 5px;
    }

    .auth-body {
      padding: 20px 30px 40px 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-base);
      font-weight: 700;
      font-size: 0.85em;
    }

    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.95em;
      background: var(--bg-input);
      color: var(--text-base);
      transition: all 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--twitch-purple);
      background: #000;
    }

    .form-group input::placeholder {
      color: #555;
    }

    /* Tabs for Login/Register switching aesthetic */
    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 30px;
    }

    .btn {
      width: 100%;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      font-size: 0.95em;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--twitch-purple);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--twitch-purple-hover);
    }

    /* Simulate "Secondary" as a less prominent button or outline */
    .btn-secondary {
      background: #35353b;
      color: var(--text-base);
    }

    .btn-secondary:hover {
      background: #45454b;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Messages */
    .message {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 0.9em;
      display: none;
      text-align: center;
    }

    .message.success {
      background: rgba(0, 255, 0, 0.1);
      color: #00ff88;
      border: 1px solid #00ff88;
      display: block;
    }

    .message.error {
      background: rgba(255, 0, 0, 0.1);
      color: #ff5555;
      border: 1px solid #ff5555;
      display: block;
    }

    /* Spinner */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .divider {
      text-align: center;
      margin: 20px 0;
      color: var(--text-alt);
      font-size: 0.8em;
      position: relative;
    }

    .divider::before,
    .divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: var(--border-color);
    }

    .divider::before {
      left: 0;
    }

    .divider::after {
      right: 0;
    }

    .back-link {
      display: block;
      text-align: center;
      margin-top: 15px;
      color: var(--twitch-purple);
      text-decoration: none;
      font-size: 0.9em;
      font-weight: 600;
    }

    .back-link:hover {
      text-decoration: underline;
    }
  </style>
  <script>
    let isLoading = false;

    // Get return URL from query params
    const urlParams = new URLSearchParams(window.location.search);
    let returnUrl = '/examples/live-streams.html';

    // Normalize return URL
    function normalizeReturnUrl(url) {
      if (!url) return '/examples/live-streams.html';
      if (url.startsWith('file://')) {
        try {
          const fileUrl = new URL(url);
          const path = fileUrl.pathname;
          const httpPath = path.replace(/^\/[A-Z]:/, '').replace(/\\/g, '/');
          if (httpPath.includes('examples')) {
            return httpPath;
          }
          return '/examples/live-streams.html';
        } catch (e) {
          console.warn('Error parsing file:// URL:', e);
          return '/examples/live-streams.html';
        }
      }
      if (url.startsWith('http://') || url.startsWith('https://')) return url;
      return url;
    }
    returnUrl = normalizeReturnUrl(returnUrl);

    function showMessage(text, isError = false) {
      const msgEl = document.getElementById('message');
      msgEl.textContent = text;
      msgEl.className = 'message ' + (isError ? 'error' : 'success');
      setTimeout(() => {
        msgEl.className = 'message';
        msgEl.style.display = 'none';
      }, 5000);
    }

    function setLoading(loading) {
      isLoading = loading;
      const registerBtn = document.getElementById('btn-register');
      const loginBtn = document.getElementById('btn-login');

      if (loading) {
        registerBtn.disabled = true;
        loginBtn.disabled = true;
        registerBtn.innerHTML = '<span class="loading"></span> Đang xử lý...';
        loginBtn.innerHTML = '<span class="loading"></span> Đang xử lý...';
      } else {
        registerBtn.disabled = false;
        loginBtn.disabled = false;
        registerBtn.innerHTML = 'Đăng ký';
        loginBtn.innerHTML = 'Đăng nhập';
      }
    }

    async function registerUser() {
      if (isLoading) return;
      if (window.location.protocol === 'file:') {
        showMessage('❌ Vui lòng mở trang qua HTTP server để đăng ký!', true);
        return;
      }

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const displayName = document.getElementById('displayName').value.trim();

      if (!email || !password) {
        showMessage('Vui lòng điền đầy đủ email và mật khẩu!', true);
        return;
      }
      if (password.length < 6) {
        showMessage('Mật khẩu phải có ít nhất 6 ký tự!', true);
        return;
      }

      setLoading(true);
      try {
        const res = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, displayName: displayName || email.split('@')[0] })
        });

        // Parse response
        let data;
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          data = await res.json();
        } else {
          throw new Error(await res.text() || 'Đăng ký thất bại');
        }

        if (!res.ok) throw new Error(data.error || 'Đăng ký thất bại');

        if (data.token && data.user) {
          showMessage('✅ Đăng ký thành công! Đang chuyển hướng...', false);

          let redirectUrl;
          if (returnUrl.startsWith('http')) {
            redirectUrl = new URL(returnUrl);
          } else {
            redirectUrl = new URL(returnUrl, window.location.origin);
          }
          redirectUrl.searchParams.set('token', data.token);
          redirectUrl.searchParams.set('name', data.user.displayName || data.user.email);
          redirectUrl.searchParams.set('email', data.user.email);

          setTimeout(() => window.location.href = redirectUrl.toString(), 1000);
        } else {
          throw new Error('Không nhận được token từ server');
        }
      } catch (error) {
        showMessage('❌ ' + error.message, true);
        setLoading(false);
      }
    }

    async function loginUser() {
      if (isLoading) return;
      if (window.location.protocol === 'file:') {
        showMessage('❌ Vui lòng mở trang qua HTTP server để đăng nhập!', true);
        return;
      }

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) {
        showMessage('Vui lòng điền đầy đủ thông tin!', true);
        return;
      }

      setLoading(true);
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        let data;
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          data = await res.json();
        } else {
          throw new Error(await res.text() || 'Đăng nhập thất bại');
        }

        if (!res.ok) {
          if (res.status === 401) throw new Error('Email hoặc mật khẩu không đúng!');
          throw new Error(data.error || 'Đăng nhập thất bại');
        }

        if (data.token && data.user) {
          showMessage('✅ Đăng nhập thành công!', false);

          let redirectUrl;
          if (returnUrl.startsWith('http')) {
            redirectUrl = new URL(returnUrl);
          } else {
            redirectUrl = new URL(returnUrl, window.location.origin);
          }
          redirectUrl.searchParams.set('token', data.token);
          redirectUrl.searchParams.set('name', data.user.displayName || data.user.email);
          redirectUrl.searchParams.set('email', data.user.email);

          setTimeout(() => window.location.href = redirectUrl.toString(), 1000);
        } else {
          throw new Error('Không nhận được token từ server');
        }
      } catch (error) {
        showMessage('❌ ' + error.message, true);
        setLoading(false);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !isLoading) loginUser();
      });
    });
  </script>
</head>

<body>
  <div class="auth-container">
    <div class="auth-header">
      <svg width="60" height="60" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" class="logo-icon">
        <defs>
          <linearGradient id="logo-gradient" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse">
            <stop offset="0%" stop-color="#00C7FD" />
            <stop offset="100%" stop-color="#9146FF" />
          </linearGradient>
        </defs>
        <path
          d="M33.5 17.4C35.5 18.55 35.5 21.45 33.5 22.6L13.5 34.15C11.5 35.3 9 33.85 9 31.55V8.45C9 6.15 11.5 4.7 13.5 5.85L33.5 17.4Z"
          fill="url(#logo-gradient)" />
      </svg>
      <div class="logo-text">StreamG8</div>
      <p>Tham gia vào vũ trụ livestream</p>
    </div>

    <div class="auth-body">
      <div id="message" class="message"></div>

      <div class="form-group">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="Ví dụ: hotboy@gmail.com" required />
      </div>

      <div class="form-group">
        <label for="password">Mật khẩu</label>
        <input id="password" type="password" placeholder="••••••••" required />
      </div>

      <div class="form-group">
        <label for="displayName">Tên hiển thị (Nếu đăng ký)</label>
        <input id="displayName" type="text" placeholder="Tên nickname của bạn" />
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" id="btn-login" onclick="loginUser()">
          Đăng nhập
        </button>
        <button class="btn btn-secondary" id="btn-register" onclick="registerUser()">
          Đăng ký tài khoản mới
        </button>
      </div>

    </div>
  </div>
</body>

</html>